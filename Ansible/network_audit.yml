---
- name: Audit Azure Network Security
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Debug secret length  # TEMP: Remove after fixing
      debug:
        msg: "AZURE_CLIENT_SECRET length: {{ (lookup('env', 'AZURE_CLIENT_SECRET') | trim | length) }} (local was 40)"
        verbosity: 0

    - name: Debug secret hash  # TEMP: Remove after fixing
      debug:
        msg: "AZURE_CLIENT_SECRET hash: {{ (lookup('env', 'AZURE_CLIENT_SECRET') | trim | hash('md5')) }} (local: 57f113ae0b692e55b510d02692927a16)"
        verbosity: 0

    - name: Get NSG facts for Central US
      azure.azcollection.azure_rm_securitygroup_info:
        resource_group: "Dev-USC-RG"
        client_id: "{{ lookup('env', 'AZURE_CLIENT_ID') | trim }}"
        secret: "{{ lookup('env', 'AZURE_CLIENT_SECRET') | trim }}"
        tenant: "{{ lookup('env', 'AZURE_TENANT_ID') | trim }}"
        subscription_id: "{{ lookup('env', 'AZURE_SUBSCRIPTION_ID') | trim }}"
      register: nsg_info

    - name: List all 'Allow' rules from the Internet
      debug:
        msg: "WARNING: {{ item.name }} allows open access from {{ item.source_address_prefix }}"
      loop: "{{ nsg_info.security_groups[0].rules | default([]) }}"
      when:
        - item.access == 'Allow'
        - item.source_address_prefix == '*'